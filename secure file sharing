Setup
Requirements: Python 3.9+, pip install flask cryptography

Run: Save as app.py, then python app.py

Use: Upload/download files securely via endpoints


# app.py
import os
import base64
import json
from flask import Flask, request, jsonify, send_file
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.primitives import hmac
from cryptography.hazmat.backends import default_backend

app = Flask(__name__)

# --- Key management ---
# Generate RSA keypair for sender and receiver
SENDER_PRIVATE_KEY = rsa.generate_private_key(public_exponent=65537, key_size=2048)
SENDER_PUBLIC_KEY = SENDER_PRIVATE_KEY.public_key()

RECEIVER_PRIVATE_KEY = rsa.generate_private_key(public_exponent=65537, key_size=2048)
RECEIVER_PUBLIC_KEY = RECEIVER_PRIVATE_KEY.public_key()

UPLOAD_DIR = "uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)

# --- Utility functions ---
def generate_aes_key_iv():
    key = os.urandom(32)  # AES-256
    iv = os.urandom(16)
    return key, iv

def aes_encrypt(data: bytes, key: bytes, iv: bytes) -> bytes:
    cipher = Cipher(algorithms.AES(key), modes.CFB(iv), backend=default_backend())
    encryptor = cipher.encryptor()
    return encryptor.update(data) + encryptor.finalize()

def aes_decrypt(data: bytes, key: bytes, iv: bytes) -> bytes:
    cipher = Cipher(algorithms.AES(key), modes.CFB(iv), backend=default_backend())
    decryptor = cipher.decryptor()
    return decryptor.update(data) + decryptor.finalize()

def rsa_encrypt(data: bytes, public_key) -> bytes:
    return public_key.encrypt(
        data,
        padding.OAEP(mgf=padding.MGF1(algorithm=hashes.SHA256()), algorithm=hashes.SHA256(), label=None)
    )

def rsa_decrypt(data: bytes, private_key) -> bytes:
    return private_key.decrypt(
        data,
        padding.OAEP(mgf=padding.MGF1(algorithm=hashes.SHA256()), algorithm=hashes.SHA256(), label=None)
    )

def sign_data(data: bytes, private_key) -> bytes:
    return private_key.sign(
        data,
        padding.PSS(mgf=padding.MGF1(hashes.SHA256()), salt_length=padding.PSS.MAX_LENGTH),
        hashes.SHA256()
    )

def verify_signature(data: bytes, signature: bytes, public_key) -> bool:
    try:
        public_key.verify(
            signature,
            data,
            padding.PSS(mgf=padding.MGF1(hashes.SHA256()), salt_length=padding.PSS.MAX_LENGTH),
            hashes.SHA256()
        )
        return True
    except Exception:
        return False

# --- API endpoints ---
@app.route("/upload", methods=["POST"])
def upload_file():
    file = request.files["file"]
    filename = file.filename
    data = file.read()

    # Generate AES key/iv
    aes_key, iv = generate_aes_key_iv()

    # Encrypt file
    encrypted_data = aes_encrypt(data, aes_key, iv)

    # Encrypt AES key with receiver's public key
    enc_key = rsa_encrypt(aes_key, RECEIVER_PUBLIC_KEY)

    # Sign encrypted data with sender's private key
    signature = sign_data(encrypted_data, SENDER_PRIVATE_KEY)

    # Save encrypted file
    filepath = os.path.join(UPLOAD_DIR, filename + ".enc")
    with open(filepath, "wb") as f:
        f.write(encrypted_data)

    # Return metadata for receiver
    return jsonify({
        "filename": filename,
        "encrypted_key": base64.b64encode(enc_key).decode(),
        "iv": base64.b64encode(iv).decode(),
        "signature": base64.b64encode(signature).decode()
    })

@app.route("/download", methods=["POST"])
def download_file():
    payload = request.get_json(force=True)
    filename = payload["filename"]
    enc_key_b64 = payload["encrypted_key"]
    iv_b64 = payload["iv"]
    signature_b64 = payload["signature"]

    filepath = os.path.join(UPLOAD_DIR, filename + ".enc")
    if not os.path.exists(filepath):
        return jsonify({"error": "File not found"}), 404

    with open(filepath, "rb") as f:
        encrypted_data = f.read()

    # Decode metadata
    enc_key = base64.b64decode(enc_key_b64)
    iv = base64.b64decode(iv_b64)
    signature = base64.b64decode(signature_b64)

    # Decrypt AES key
    aes_key = rsa_decrypt(enc_key, RECEIVER_PRIVATE_KEY)

    # Verify signature
    if not verify_signature(encrypted_data, signature, SENDER_PUBLIC_KEY):
        return jsonify({"error": "Signature verification failed"}), 400

    # Decrypt file
    decrypted_data = aes_decrypt(encrypted_data, aes_key, iv)

    # Save decrypted file
    outpath = os.path.join(UPLOAD_DIR, filename)
    with open(outpath, "wb") as f:
        f.write(decrypted_data)

    return send_file(outpath, as_attachment=True)

# --- Run server ---
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000, debug=True)



curl -X POST http://localhost:8000/upload \
 -F "file=@secret.pdf"



curl -X POST http://localhost:8000/download \
 -H "Content-Type: application/json" \
 -d '{"filename":"secret.pdf","encrypted_key":"...","iv":"...","signature":"..."}'
